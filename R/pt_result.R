#' Generate PT score plot and fit a line of all points
#'
#' @param pt generated by ATACseqQC package and contains mean coverage and PT score of each point
#' @param outliers True —— including all points ; False —— excluding outliers
#' @param dir dir output directory
#'
#' @return p value of fitted line (whether the slope is significantly bigger than 0)
#' @export
#'
#' @examples
#' \dontrun{
#' p_PT<-pt_result(pt, outliers=TRUE, dir0)
#' p_PT_excout<-pt_result(pt, outliers=FALSE, dir0)
#' }

pt_result<-function(pt, outliers, dir){
  if(outliers==FALSE){
    out_PTscore<-boxplot.stats(pt$log2meanCoverage)$out
    PT_score_rmout<-pt$PT_score[which(! pt$log2meanCoverage %in% out_PTscore)]
    PT_log2meanCoverage_rmout<-pt$log2meanCoverage[which(! pt$log2meanCoverage %in% as.numeric(out_PTscore))]
    pt_data<-data.frame(PT_log2meanCoverage_rmout,PT_score_rmout)
    colnames(pt_data)<-c("coverage","pt_score")
    lm_pt<-lm(pt_score ~ coverage,data=pt_data)
    p_pt<-pt(summary(lm_pt)$coefficients[2,3], lm_pt$df, lower = F) #已知t值和自由度的话,可以使用pt()计算p value; 如果设为 FALSE 则是计算 P[X > x] 的概率.
    print(paste0("1./The P value of PT score excluding outliers is ", p_pt))
    png(paste0(dir,"_PT_score_excout.png"),res=150, width = 2400,height = 1200)
    plot(PT_log2meanCoverage_rmout, PT_score_rmout,
         xlab="log2 mean coverage",
         ylab="Promoter vs Transcript",
         ylim=c(-15, 15),
         main="PT score")
    text(-5, 2, paste0("P value is ", p_pt))
    abline(lm_pt,col="red",lwd=2)
    dev.off()
  }

  if(outliers==TRUE){
    lm_pt<-lm(pt$PT_score ~ pt$log2meanCoverage)
    p_pt<-pt(summary(lm_pt)$coefficients[2,3], lm_pt$df, lower = F) #已知t值和自由度的话,可以使用pt()计算p value; 如果设为 FALSE 则是计算 P[X > x] 的概率.
    print(paste0("2./The P value of PT score is ", p_pt))
    png(paste0(dir,"_PT_score.png"),res=150, width = 2400,height = 1200)
    plot(pt$log2meanCoverage, pt$PT_score,
         xlab="log2 mean coverage",
         ylab="Promoter vs Transcript",
         ylim=c(-15, 15),
         main="PT score")
    text(-5, 2, paste0("P value is ", p_pt))
    abline(lm_pt,col="red",lwd=2)
    dev.off()
  }

  return(p_pt)

}
